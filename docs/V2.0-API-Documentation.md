# V2.0 API Documentation

## 🚀 Overview

V2.0 is a major upgrade to the Top Tier Men platform that introduces enhanced security, performance, and stability features. This documentation covers all V2.0 API endpoints, utilities, and integration patterns.

## 📊 V2.0 Features

### ✅ Completed Features
- **Database Security**: 200+ RLS policies, 40+ foreign key constraints
- **API Standardization**: Consistent response formats, error handling, rate limiting
- **State Management**: Centralized V2.0 state context with persistence
- **Caching Strategy**: Multi-level caching (memory, session, local, network)
- **Error Recovery**: Intelligent error handling with retry mechanisms
- **Monitoring**: Performance tracking and system health monitoring
- **Authentication**: Enhanced auth with role-based access control

### 🔧 Technical Stack
- **Backend**: Next.js 14 with App Router
- **Database**: Supabase with PostgreSQL
- **Authentication**: Supabase Auth with RLS
- **Caching**: Multi-strategy cache system
- **Monitoring**: Custom V2.0 monitoring system

## 🌐 API Endpoints

### Health Check
```http
GET /api/v2/health
POST /api/v2/health
```

**Response:**
```json
{
  "success": true,
  "data": {
    "health": {
      "status": "healthy",
      "version": "2.0",
      "features": {
        "rls": "enabled",
        "foreignKeys": "enabled",
        "v2Api": "enabled",
        "monitoring": "enabled",
        "caching": "enabled",
        "errorRecovery": "enabled"
      }
    }
  },
  "timestamp": "2025-08-25T19:28:19.956Z",
  "version": "2.0"
}
```

### Dashboard API
```http
GET /api/v2/dashboard
POST /api/v2/dashboard
PUT /api/v2/dashboard
DELETE /api/v2/dashboard
```

**Features:**
- Authentication required
- Rate limiting (50 requests/minute)
- Parallel data fetching
- Cache headers
- Error recovery

**Response:**
```json
{
  "success": true,
  "data": {
    "dashboard": {
      "userProfile": { /* user data */ },
      "notifications": [ /* notifications */ ],
      "recentActivity": [ /* activity */ ],
      "stats": { /* user stats */ },
      "timestamp": "2025-08-25T19:28:19.956Z"
    },
    "version": "2.0"
  }
}
```

### Users API
```http
GET /api/v2/users
POST /api/v2/users
PUT /api/v2/users
DELETE /api/v2/users
```

**Features:**
- Admin authentication required
- Rate limiting (100 requests/minute)
- Pagination support
- Search functionality
- Sorting options

**Query Parameters:**
- `page`: Page number (default: 1)
- `limit`: Items per page (default: 10)
- `search`: Search term
- `sortBy`: Sort field (default: created_at)
- `sortOrder`: asc/desc (default: desc)

## 🔧 V2.0 Utilities

### API Utils (`@/lib/v2-api-utils`)

#### Response Helpers
```typescript
import { createSuccessResponse, createErrorResponse } from '@/lib/v2-api-utils';

// Success response
const response = createSuccessResponse(data, 'Operation successful');

// Error response
const error = createErrorResponse('Something went wrong', 500);
```

#### Authentication
```typescript
import { authenticateRequest, requireAdmin } from '@/lib/v2-api-utils';

// Basic authentication
const auth = await authenticateRequest(request);
if (auth.error) {
  return createErrorResponse(auth.error, 401);
}

// Admin authentication
const admin = await requireAdmin(request);
if (admin.error) {
  return createErrorResponse(admin.error, 403);
}
```

#### Rate Limiting
```typescript
import { checkRateLimit } from '@/lib/v2-api-utils';

if (!checkRateLimit(`endpoint_${clientIp}`, 100, 60000)) {
  return createErrorResponse('Rate limit exceeded', 429);
}
```

#### Database Operations
```typescript
import { safeDbOperation } from '@/lib/v2-api-utils';

const { data, error } = await safeDbOperation(
  async () => {
    // Database operation
    return result;
  },
  'Failed to perform operation'
);
```

### State Management (`@/contexts/V2StateContext`)

```typescript
import { useV2State } from '@/hooks/useV2State';

function MyComponent() {
  const { 
    user, 
    ui, 
    data, 
    error, 
    performance,
    addNotification,
    setLoadingState,
    updateUserProfile 
  } = useV2State();

  // Use V2.0 state
  return <div>Hello {user?.full_name}</div>;
}
```

### Caching (`@/lib/v2-cache-strategy`)

```typescript
import { useV2Cache, useV2CachedData } from '@/hooks/useV2Cache';

function MyComponent() {
  const { set, get, clearCacheData } = useV2Cache();
  
  // Cache data
  set('user-profile', userData, { ttl: 300000, strategy: 'hybrid' });
  
  // Get cached data
  const cachedData = get('user-profile');
  
  // Use cached data hook
  const { data, loading, error } = useV2CachedData(
    'user-profile',
    fetchUserProfile,
    { ttl: 300000 }
  );
}
```

### Error Recovery (`@/lib/v2-error-recovery`)

```typescript
import { useV2ErrorRecovery } from '@/hooks/useV2ErrorRecovery';

function MyComponent() {
  const { handleError, retryOperation } = useV2ErrorRecovery();
  
  const handleApiCall = async () => {
    try {
      const result = await apiCall();
      return result;
    } catch (error) {
      handleError(error, {
        severity: 'medium',
        category: 'api',
        recovery: 'retry'
      });
    }
  };
}
```

### Monitoring (`@/lib/v2-monitoring`)

```typescript
import { useV2Monitoring } from '@/hooks/useV2Monitoring';

function MyComponent() {
  const { 
    trackFeatureUsage, 
    trackApiCall, 
    trackError,
    trackPerformance 
  } = useV2Monitoring();
  
  // Track feature usage
  trackFeatureUsage('dashboard-view', { userId: user.id });
  
  // Track API calls
  trackApiCall('/api/v2/dashboard', { method: 'GET', duration: 150 });
  
  // Track errors
  trackError('api-error', { endpoint: '/api/v2/users', status: 500 });
}
```

## 🎣 V2.0 Hooks

### Available Hooks
- `useV2State()` - Centralized state management
- `useV2Cache()` - Multi-strategy caching
- `useV2ErrorRecovery()` - Error handling and recovery
- `useV2Monitoring()` - Performance and usage tracking
- `useV2Dashboard()` - Dashboard data management

### Hook Usage Pattern
```typescript
import { 
  useV2State, 
  useV2Cache, 
  useV2ErrorRecovery, 
  useV2Monitoring 
} from '@/hooks';

function V2Component() {
  const { user, addNotification } = useV2State();
  const { set, get } = useV2Cache();
  const { handleError } = useV2ErrorRecovery();
  const { trackFeatureUsage } = useV2Monitoring();
  
  // Component logic
}
```

## 🔒 Security Features

### Row Level Security (RLS)
- **200+ policies** across all user-related tables
- **User-specific access** to personal data
- **Admin access** for management functions
- **Public read access** for non-sensitive data

### Foreign Key Constraints
- **40+ constraints** ensuring data integrity
- **Cascade deletes** for user data cleanup
- **Referential integrity** across all relationships
- **Orphaned record prevention**

### Authentication & Authorization
- **JWT-based authentication** via Supabase
- **Role-based access control** (user/admin)
- **Token validation** on all protected endpoints
- **Session management** with auto-refresh

## 📈 Performance Features

### Caching Strategy
- **Memory cache**: Fast access for frequently used data
- **Session cache**: User-specific data persistence
- **Local storage**: Offline capability
- **Network cache**: Reduced API calls
- **Hybrid strategy**: Optimal performance

### API Optimization
- **Parallel data fetching** for dashboard
- **Pagination** for large datasets
- **Search optimization** with indexed queries
- **Rate limiting** to prevent abuse
- **Cache headers** for browser caching

### Error Recovery
- **Automatic retry** with exponential backoff
- **Fallback strategies** for failed operations
- **Graceful degradation** when services are unavailable
- **Error categorization** for better handling

## 🚀 Integration Guide

### 1. Setup V2.0 Providers
```typescript
// src/app/layout.tsx
import { V2StateProvider } from '@/contexts/V2StateContext';
import { ErrorBoundary } from '@/components/ErrorBoundary';

export default function RootLayout({ children }) {
  return (
    <html>
      <body>
        <ErrorBoundary>
          <V2StateProvider>
            {children}
          </V2StateProvider>
        </ErrorBoundary>
      </body>
    </html>
  );
}
```

### 2. Use V2.0 Hooks in Components
```typescript
import { useV2State, useV2Cache } from '@/hooks';

function MyComponent() {
  const { user } = useV2State();
  const { get } = useV2Cache();
  
  // Component logic
}
```

### 3. Create V2.0 API Routes
```typescript
// src/app/api/v2/my-endpoint/route.ts
import { withApiHandler, createSuccessResponse } from '@/lib/v2-api-utils';

export const GET = withApiHandler(async (request) => {
  // Your API logic here
  return createSuccessResponse({ data: 'success' });
});
```

## 📊 Monitoring & Analytics

### Available Metrics
- **API Performance**: Response times, error rates
- **User Activity**: Feature usage, session duration
- **System Health**: Uptime, resource usage
- **Error Tracking**: Error frequency, types, recovery
- **Cache Performance**: Hit rates, efficiency

### Monitoring Dashboard
- Real-time system health
- Performance metrics
- Error tracking
- User analytics
- Cache statistics

## 🔄 Migration from V1

### Automatic Migration
- V2.0 systems are **backward compatible**
- Existing V1 APIs continue to work
- Gradual migration to V2.0 endpoints
- No breaking changes to existing functionality

### Migration Checklist
- [ ] Update layout to include V2.0 providers
- [ ] Replace V1 API calls with V2.0 endpoints
- [ ] Implement V2.0 hooks in components
- [ ] Add error recovery to critical paths
- [ ] Enable monitoring for key features

## 🎯 Best Practices

### API Development
1. Always use `withApiHandler` wrapper
2. Implement proper authentication checks
3. Add rate limiting for public endpoints
4. Use `safeDbOperation` for database calls
5. Include appropriate cache headers

### Component Development
1. Use V2.0 hooks for state management
2. Implement error boundaries
3. Add performance monitoring
4. Use caching for expensive operations
5. Handle loading and error states

### Security
1. Always validate user permissions
2. Use RLS policies for data access
3. Implement proper input validation
4. Monitor for suspicious activity
5. Keep dependencies updated

## 📞 Support

For questions about V2.0 implementation:
- Check the integration report: `v2-integration-report.json`
- Review API test results: `v2-api-test-results.json`
- Consult the V2.0 systems documentation
- Contact the development team

---

**V2.0 Status**: ✅ **FULLY INTEGRATED**  
**Last Updated**: 2025-08-25  
**Version**: 2.0.0
